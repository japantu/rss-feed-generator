name: Generate RSS Feed

on:
  schedule:
    - cron: '*/10 6-23 * * *' # 日中10分おき（UTC）
    - cron: '*/30 1-5 * * *'  # 深夜30分おき（UTC）
    - cron: '*/15 0 * * *'    # 0時台15分おき（UTC）
  workflow_dispatch:

permissions:
  # ⭐ keepalive のため write に変更（必須）
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # push するので資格情報を残す
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -V
          pip install -r requirements.txt

      # rss_cache.json を永続化（必要なら）
      - name: Restore rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}
          restore-keys: |
            rss-cache-

      - name: Generate RSS
        run: |
          python rss_generator.py
          test -f public/rss_output.xml

      - name: Compute RSS hash
        id: hash
        run: |
          sha256sum public/rss_output.xml | awk '{print $1}' > .rss_hash_current

      - name: Restore previous hash
        uses: actions/cache@v4
        with:
          path: .rss_hash_prev
          key: rss-hash-${{ github.ref_name }}
          restore-keys: |
            rss-hash-

      - name: Check diff
        id: diff
        run: |
          if [ -f .rss_hash_prev ] && cmp -s .rss_hash_prev .rss_hash_current; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 差分があるときだけ Pages へアップロード & デプロイ
      - name: Upload artifact (if changed)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages (if changed)
        if: steps.diff.outputs.changed == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      # ハッシュ保存（次回比較用）
      - name: Save current hash (if changed)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: .rss_hash_current
          key: rss-hash-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            rss-hash-

      - name: Move hash to prev (if changed)
        if: steps.diff.outputs.changed == 'true'
        run: mv .rss_hash_current .rss_hash_prev || true

      - name: Save rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            rss-cache-

      # ⭐ ここが keepalive（1日1回だけコミット）
      - name: Keep repository active (commit once per day)
        run: |
          set -e
          TODAY=$(date -u +%Y-%m-%d)
          echo "$TODAY" > .keepalive
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 同日の再実行では diff なし → コミット/プッシュしない
          if ! git diff --quiet -- .keepalive; then
            git add .keepalive
            git commit -m "chore: keepalive $TODAY"
            git push
          fi
