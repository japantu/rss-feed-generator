name: Generate & Deploy RSS

on:
  schedule:
    # 日中（6時-24時）は10分おき
    - cron: '*/10 6-23 * * *'
    # 深夜（1時-5時）は30分おき  
    - cron: '*/30 1-5 * * *'
    # 0時台は15分おき（中間設定）
    - cron: '*/15 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -V
          pip install -r requirements.txt

      # rss_cache.json を永続化（復元）
      - name: Restore rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}
          restore-keys: |
            rss-cache-

      - name: Generate RSS
        run: |
          python rss_generator.py
          test -f public/rss_output.xml

      # 生成物のハッシュを取り、前回と同一か比較
      - name: Compute RSS hash
        id: hash
        run: |
          sha256sum public/rss_output.xml | awk '{print $1}' > .rss_hash_current

      - name: Restore previous hash
        id: hashrestore
        uses: actions/cache@v4
        with:
          path: .rss_hash_prev
          key: rss-hash-${{ github.ref_name }}
          restore-keys: |
            rss-hash-

      - name: Check diff
        id: diff
        run: |
          if [ -f .rss_hash_prev ] && cmp -s .rss_hash_prev .rss_hash_current; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 差分があるときのみ Pages 用アーティファクトをアップロード
      - name: Upload artifact (if changed)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      # rss_cache.json を保存（更新後）
      - name: Save rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            rss-cache-

      # ハッシュも保存（次回比較用）
      - name: Save current hash
        if: steps.diff.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: .rss_hash_current
          key: rss-hash-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            rss-hash-

      - name: Move hash to prev
        if: steps.diff.outputs.changed == 'true'
        run: mv .rss_hash_current .rss_hash_prev || true

  deploy:
    needs: build
    if: needs.build.outputs.changed != 'false' || steps.diff.outputs.changed == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
