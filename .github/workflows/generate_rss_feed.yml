name: Generate RSS Feed

on:
  schedule:
    - cron: '*/10 6-23 * * *' # 日中10分おき（UTC）
    - cron: '*/30 1-5 * * *'  # 深夜30分おき（UTC）
    - cron: '*/15 0 * * *'    # 0時台15分おき（UTC）
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -V
          pip install -r requirements.txt

      - name: Restore rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}
          restore-keys: |
            rss-cache-

      - name: Generate RSS
        run: |
          python rss_generator.py
          test -f public/rss_output.xml

      - name: Compute RSS hash
        id: hash
        run: |
          sha256sum public/rss_output.xml | awk '{print $1}' > .rss_hash_current

      - name: Restore previous hash
        uses: actions/cache@v4
        with:
          path: .rss_hash_prev
          key: rss-hash-${{ github.ref_name }}
          restore-keys: |
            rss-hash-

      - name: Check diff
        id: diff
        run: |
          if [ -f .rss_hash_prev ] && cmp -s .rss_hash_prev .rss_hash_current; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact (if changed)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages (if changed)
        if: steps.diff.outputs.changed == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Save current hash (if changed)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/cache@v4
        with:
          path: .rss_hash_current
          key: rss-hash-${{ github.ref_name }}-${{ github.run_id }}

      - name: Move hash to prev (if changed)
        if: steps.diff.outputs.changed == 'true'
        run: mv .rss_hash_current .rss_hash_prev || true

      - name: Save rss_cache.json
        uses: actions/cache@v4
        with:
          path: rss_cache.json
          key: rss-cache-${{ github.ref_name }}-${{ github.run_id }}

      # ⭐ 重要：毎回必ずコミットする（同日判定を削除）
      - name: Keep repository active (force commit every run)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # タイムスタンプを秒単位で記録（毎回必ず変わる）
          date -u +"%Y-%m-%d %H:%M:%S" > .keepalive
          
          git add .keepalive
          
          # 必ずコミット（差分チェックなし）
          git commit -m "chore: keepalive $(date -u +%Y-%m-%d)" || true
          
          # プッシュ（リトライ付き）
          for i in {1..5}; do
            if git push origin HEAD:${GITHUB_REF#refs/heads/}; then
              echo "✓ Keepalive pushed successfully"
              exit 0
            fi
            echo "Push attempt $i failed, retrying..."
            git pull --rebase origin ${GITHUB_REF#refs/heads/}
            sleep $((i * 2))
          done
          
          echo "⚠ Warning: Failed to push keepalive after 5 attempts"
          exit 1
